steps:
  # initialise NPM config
  - name: node:lts-alpine
    id: npm-init
    entrypoint: sh
    args:
      - '-c'
      - |
        echo "@$_NPM_ARTIFACT_SCOPE:registry=https://$_NPM_ARTIFACT_DOMAIN/$PROJECT_ID/$_NPM_ARTIFACT_REGISTRY/" > .npmrc
        echo "//$_NPM_ARTIFACT_DOMAIN/$_MGT_PROJECT_ID/$_NPM_ARTIFACT_REGISTRY/:_password=\"\"" >> .npmrc
        echo "//$_NPM_ARTIFACT_DOMAIN/$_MGT_PROJECT_ID/$_NPM_ARTIFACT_REGISTRY/:username=oauth2accesstoken" >> .npmrc
        echo "//$_NPM_ARTIFACT_DOMAIN/$_MGT_PROJECT_ID/$_NPM_ARTIFACT_REGISTRY/:email=not.valid@email.com" >> .npmrc
        echo "//$_NPM_ARTIFACT_DOMAIN/$_MGT_PROJECT_ID/$_NPM_ARTIFACT_REGISTRY/:always-auth=true" >> .npmrc
        npx -v
  # publish pilets using node script
  - name: node:lts
    id: npm-access
    entrypoint: sh
    args:
      - '-c'
      - |
        npx google-artifactregistry-auth .npmrc
        cat .npmrc

substitutions:
  _NPM_ARTIFACT_DOMAIN: 'europe-west2-npm.pkg.dev'
  _NPM_ARTIFACT_REGISTRY: 'guru-central-npm'
  _NPM_ARTIFACT_SCOPE: 'guru-playground'
  _MGT_PROJECT_ID: 'guru-playground'